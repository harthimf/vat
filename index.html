<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>حاسبة إجمالي فواتير PDF + ضريبة 15%</title>

  <!-- Font -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600&display=swap');
  </style>

  <style>
    :root{
      --bg:#F7FCFF;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --border:#e5e7eb;
      --primary:#636BB1;
      --accent:#FBE167;
      --info:#E8F9FF;
      --danger:#ef4444;
      --ok:#16a34a;
      --shadow: 0 10px 25px rgba(0,0,0,.06);
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: Rubik, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wrap{
      max-width:1100px;
      margin:24px auto;
      padding:0 16px 40px;
    }
    header{
      background: linear-gradient(135deg, var(--info), #fff);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:18px 18px;
      box-shadow: var(--shadow);
    }
    h1{
      margin:0 0 6px;
      font-size:20px;
    }
    .sub{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.6;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 880px){
      .grid{ grid-template-columns: 1fr; }
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
    }
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .btn{
      background: var(--primary);
      color:#fff;
      border:none;
      padding:10px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
    }
    .btn.secondary{
      background:#fff;
      color:var(--primary);
      border:1px solid rgba(99,107,177,.35);
    }
    .btn.danger{
      background: var(--danger);
    }
    .file{
      display:flex;
      gap:10px;
      align-items:center;
      flex:1;
      min-width:260px;
    }
    input[type="file"]{
      width:100%;
      padding:10px;
      border:1px dashed rgba(99,107,177,.5);
      border-radius:14px;
      background: #fff;
    }
    .toggle{
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      min-width:260px;
    }
    .toggle label{
      font-size:13px;
      color: var(--muted);
      line-height:1.5;
    }
    .toggle input{
      transform: scale(1.1);
    }
    .summary{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 720px){
      .summary{ grid-template-columns: 1fr; }
    }
    .kpi{
      background: linear-gradient(135deg, #fff, var(--info));
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:12px;
    }
    .kpi .label{
      color:var(--muted);
      font-size:12px;
      margin-bottom:6px;
    }
    .kpi .value{
      font-size:20px;
      font-weight:700;
      letter-spacing:.2px;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius: var(--radius);
      border:1px solid var(--border);
      background:#fff;
      box-shadow: var(--shadow);
      margin-top:14px;
    }
    thead th{
      text-align:right;
      font-size:12px;
      color:var(--muted);
      background: #f9fafb;
      border-bottom:1px solid var(--border);
      padding:10px 10px;
      position:sticky;
      top:0;
      z-index:1;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      vertical-align:top;
      font-size:13px;
    }
    tbody tr:last-child td{ border-bottom:none; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
      border:1px solid var(--border);
      background:#fff;
      white-space:nowrap;
    }
    .pill.ok{ border-color: rgba(22,163,74,.25); background: rgba(22,163,74,.08); color: var(--ok); }
    .pill.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); color: #b45309; }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      direction:ltr;
      unicode-bidi: plaintext;
      color:#111827;
    }
    .muted{ color: var(--muted); font-size:12px; }
    .small{ font-size:12px; }
    .num{ text-align:left; direction:ltr; unicode-bidi: plaintext; }
    .edit{
      width:130px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius: 12px;
      outline:none;
      font-family: inherit;
      direction:ltr;
    }
    .row-actions{
      display:flex;
      gap:8px;
      justify-content:flex-start;
      flex-wrap:wrap;
    }
    details{
      margin-top:8px;
      background: #fff;
      border:1px solid var(--border);
      border-radius: 14px;
      padding:10px 12px;
    }
    details summary{
      cursor:pointer;
      color: var(--primary);
      font-weight:600;
      font-size:13px;
    }
    pre{
      margin:10px 0 0;
      background:#0b1020;
      color:#dbeafe;
      padding:12px;
      border-radius:14px;
      overflow:auto;
      max-height:240px;
      direction:ltr;
    }
    .note{
      margin-top:12px;
      color: var(--muted);
      font-size:12px;
      line-height:1.8;
    }
  </style>

  <!-- pdf.js (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js"></script>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>رفع فواتير PDF → استخراج الإجمالي النهائي + ضريبة 15%</h1>
      <p class="sub">
        ارفع ملفات PDF (متعددة)، وسيتم محاولة استخراج قيمة <b>الإجمالي النهائي</b> و <b>ضريبة 15%</b> من كل فاتورة.
        <br>
        إذا كان الـPDF مسح ضوئي (بدون نص)، عدّل خانة “تعديل الإجمالي” يدويًا.
      </p>

      <div class="grid">
        <div class="card">
          <div class="controls">
            <div class="file">
              <input id="fileInput" type="file" accept="application/pdf" multiple />
            </div>
            <button class="btn" id="processBtn">معالجة الملفات</button>
            <button class="btn secondary" id="exportBtn" disabled>تصدير CSV</button>
            <button class="btn danger" id="clearBtn">مسح الكل</button>
          </div>

          <div class="note">
            • هذه النسخة تعمل بمحاولتين: مع Worker ثم بدون Worker لحل “فشل القراءة”.<br>
            • خيار الضريبة بالأسفل يحدد هل الإجمالي المستخرج <b>شامل الضريبة</b> أم <b>قبل الضريبة</b>.
          </div>
        </div>

        <div class="card">
          <div class="toggle">
            <input id="includesVat" type="checkbox" checked />
            <label for="includesVat">
              الإجمالي المستخرج من الفاتورة <b>شامل الضريبة</b> (15%)؟<br>
              <span class="muted">إذا أزلت العلامة: سيتم اعتباره قبل الضريبة ثم تُضاف 15%.</span>
            </label>
          </div>

          <div style="height:10px"></div>

          <div class="summary">
            <div class="kpi">
              <div class="label">إجمالي قبل الضريبة (Net)</div>
              <div class="value mono" id="sumNet">0.00</div>
            </div>
            <div class="kpi">
              <div class="label">إجمالي الضريبة 15% (VAT)</div>
              <div class="value mono" id="sumVat">0.00</div>
            </div>
            <div class="kpi">
              <div class="label">الإجمالي النهائي (Gross)</div>
              <div class="value mono" id="sumGross">0.00</div>
            </div>
          </div>

          <div class="note">
            عدد الفواتير: <b id="count">0</b>
          </div>
        </div>
      </div>
    </header>

    <table aria-label="Invoices table">
      <thead>
        <tr>
          <th style="width:240px">الملف</th>
          <th>الطريقة</th>
          <th class="num">الإجمالي المستخرج</th>
          <th class="num">قبل الضريبة</th>
          <th class="num">ضريبة 15%</th>
          <th class="num">الإجمالي النهائي</th>
          <th style="width:160px">تعديل الإجمالي</th>
          <th style="width:120px">إجراءات</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr>
          <td colspan="8" class="muted">لم يتم رفع ملفات بعد.</td>
        </tr>
      </tbody>
    </table>

    <details>
      <summary>عرض سجلات الاستخراج (للتشخيص)</summary>
      <pre id="log"></pre>
    </details>
  </div>

<script>
(function(){
  "use strict";

  // إعداد worker (قد يفشل أحياناً بسبب إضافات/سياسات أمان)
  if (window.pdfjsLib && pdfjsLib.GlobalWorkerOptions) {
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js";
  }

  var TAX_RATE = 0.15;

  var fileInput = document.getElementById('fileInput');
  var processBtn = document.getElementById('processBtn');
  var exportBtn = document.getElementById('exportBtn');
  var clearBtn = document.getElementById('clearBtn');
  var includesVatEl = document.getElementById('includesVat');

  var tbody = document.getElementById('tbody');
  var logEl = document.getElementById('log');

  var sumNetEl = document.getElementById('sumNet');
  var sumVatEl = document.getElementById('sumVat');
  var sumGrossEl = document.getElementById('sumGross');
  var countEl = document.getElementById('count');

  var invoices = [];

  function log(msg){
    logEl.textContent += msg + "\n";
    logEl.scrollTop = logEl.scrollHeight;
  }
  function resetLog(){ logEl.textContent = ""; }

  function formatMoney(n){
    if (!isFinite(n)) return "—";
    return Number(n).toFixed(2);
  }

  function makeId(){
    try{
      if (window.crypto && typeof window.crypto.randomUUID === "function") return window.crypto.randomUUID();
    }catch(e){}
    return ("id_" + Date.now() + "_" + Math.random().toString(16).slice(2));
  }

  function toLatinDigits(s){
    var map = {
      '٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9',
      '۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9'
    };
    return String(s || "").replace(/[٠-٩۰-۹]/g, function(d){ return map[d] || d; });
  }

  function normalizeNumberString(s){
    var t = toLatinDigits(s);
    t = t.replace(/[٬،]/g, ",");
    t = t.replace(/[٫]/g, ".");
    t = t.replace(/(SAR|ر\.س|ريال|﷼|SR|\s)/gi, "");
    t = t.replace(/,/g, "");
    return t;
  }

  function parseNumber(s){
    var t = normalizeNumberString(s);
    var n = Number(t);
    return isFinite(n) ? n : null;
  }

  function findNumbersInText(text){
    var re = /([0-9٠-٩۰-۹]{1,3}(?:[,\s٬،][0-9٠-٩۰-۹]{3})*(?:[\.٫][0-9٠-٩۰-۹]{1,3})?|[0-9٠-٩۰-۹]+(?:[\.٫][0-9٠-٩۰-۹]{1,3})?)/g;
    var out = [];
    var m;
    while ((m = re.exec(text)) !== null){
      var n = parseNumber(m[1]);
      if (n !== null) out.push(n);
    }
    return out;
  }

  function getY(item){ return (item && item.transform && item.transform[5]) ? item.transform[5] : 0; }
  function getX(item){ return (item && item.transform && item.transform[4]) ? item.transform[4] : 0; }

  function itemsToLines(items){
    var sorted = (items || []).slice().sort(function(a,b){
      var ya = getY(a), yb = getY(b);
      var xa = getX(a), xb = getX(b);
      if (Math.abs(ya - yb) > 2) return yb - ya;
      return xa - xb;
    });

    var lines = [];
    var current = [];
    var currentY = null;

    for (var i=0;i<sorted.length;i++){
      var it = sorted[i];
      var y = getY(it);
      var str = (it && it.str ? String(it.str) : "").trim();
      if (!str) continue;

      if (currentY === null || Math.abs(y - currentY) <= 2){
        current.push(str);
        currentY = (currentY === null) ? y : (currentY + y) / 2;
      } else {
        lines.push(current.join(' ').replace(/\s+/g,' ').trim());
        current = [str];
        currentY = y;
      }
    }
    if (current.length) lines.push(current.join(' ').replace(/\s+/g,' ').trim());
    return lines.filter(function(x){ return !!x; });
  }

  function computeBreakdown(total, includesVat){
    var net, vat, gross;
    if (includesVat){
      gross = total;
      net = gross / (1 + TAX_RATE);
      vat = gross - net;
    } else {
      net = total;
      vat = net * TAX_RATE;
      gross = net + vat;
    }
    return {net: net, vat: vat, gross: gross};
  }

  // استخراج رقم قريب من سطر Label
  function extractByLabel(lines, labels, opts){
    opts = opts || {};
    var windowSize = (typeof opts.window === "number") ? opts.window : 3;
    var mustHave = opts.mustHave || [];

    for (var i = lines.length - 1; i >= 0; i--) {
      var line = lines[i] || "";
      var hasLabel = false;

      for (var k=0;k<labels.length;k++){
        if (line.indexOf(labels[k]) !== -1) { hasLabel = true; break; }
      }
      if (!hasLabel) continue;

      if (mustHave.length){
        var ok = false;
        for (var m=0;m<mustHave.length;m++){
          if (line.indexOf(mustHave[m]) !== -1) { ok = true; break; }
        }
        if (!ok){
          var neighbor = (lines[i-1] || "") + " " + (lines[i+1] || "");
          for (var m2=0;m2<mustHave.length;m2++){
            if (neighbor.indexOf(mustHave[m2]) !== -1) { ok = true; break; }
          }
          if (!ok) continue;
        }
      }

      for (var w = 0; w <= windowSize; w++) {
        var candidates = [];
        if (lines[i]) candidates.push(lines[i]);
        if (lines[i - w]) candidates.push(lines[i - w]);
        if (lines[i + w]) candidates.push(lines[i + w]);

        for (var c=0;c<candidates.length;c++){
          var nums = findNumbersInText(candidates[c]);
          if (nums.length) {
            return { value: Math.max.apply(null, nums), line: candidates[c] };
          }
        }
      }
      return null;
    }
    return null;
  }

  function extractVatFromLines(lines){
    var vat = extractByLabel(
      lines,
      ["ضريبة القيمة المضافة", "VAT", "Value Added Tax"],
      { window: 4, mustHave: ["15%","15 %","15"] }
    );
    return vat ? vat.value : null;
  }

  function chooseTotalFromLines(lines){
    var gross = extractByLabel(lines, [
      "الإجمالي النهائي",
      "الاجمالي النهائي",
      "Grand Total",
      "Total Due",
      "Amount Due",
      "Invoice Total"
    ], { window: 4 });

    if (gross) return { score: 999, value: gross.value, method: "مطابقة: الإجمالي النهائي", line: gross.line };

    var alt = extractByLabel(lines, [
      "المبلغ المستحق",
      "المبلغ الإجمالي",
      "المجموع النهائي"
    ], { window: 4 });

    if (alt) return { score: 900, value: alt.value, method: "مطابقة قوية", line: alt.line };

    var allNums = [];
    for (var i=0;i<lines.length;i++){
      var nums = findNumbersInText(lines[i]);
      if (nums.length) allNums = allNums.concat(nums);
    }
    if (allNums.length) return { score: 1, value: Math.max.apply(null, allNums), method: "تخمين (أكبر رقم)", line: "—" };

    return null;
  }

  // ✅ استخراج النص مع خيار تعطيل الـWorker (لإصلاح “فشل القراءة”)
  async function extractTextFromPdf(arrayBuffer, disableWorker){
    var data = new Uint8Array(arrayBuffer);

    var loadingTask = pdfjsLib.getDocument({
      data: data,
      disableWorker: !!disableWorker,
      stopAtErrors: false,
      useSystemFonts: true
    });

    var pdf = await loadingTask.promise;

    var allLines = [];
    for (var p = 1; p <= pdf.numPages; p++){
      var page = await pdf.getPage(p);
      var textContent = await page.getTextContent();
      var lines = itemsToLines(textContent.items || []);
      allLines = allLines.concat(lines);
    }
    return allLines;
  }

  function friendlyError(e){
    var name = (e && e.name) ? e.name : "";
    var msg = (e && e.message) ? e.message : String(e || "");
    if (name === "PasswordException") return "الملف محمي بكلمة مرور ولا يمكن قراءته.";
    if (/InvalidPDF/i.test(msg) || name === "InvalidPDFException") return "الملف ليس PDF صالح أو تالف.";
    if (/worker/i.test(msg) || /Setting up fake worker/i.test(msg)) return "مشكلة Worker (سيتم استخدام وضع بدون Worker).";
    return msg;
  }

  async function processFile(file){
    var id = makeId();
    var buf = await file.arrayBuffer();

    log("— معالجة: " + file.name);

    var lines = [];
    var usedWorker = true;

    // محاولة 1: بالـWorker
    try{
      lines = await extractTextFromPdf(buf, false);
      log("  • تم استخراج " + lines.length + " سطر (مع Worker)");
    }catch(e1){
      log("  ⚠ فشل بالـWorker: " + friendlyError(e1));
      usedWorker = false;

      // محاولة 2: بدون Worker
      try{
        lines = await extractTextFromPdf(buf, true);
        log("  • تم استخراج " + lines.length + " سطر (بدون Worker)");
      }catch(e2){
        log("  ✗ فشل القراءة نهائياً: " + friendlyError(e2));
        var methodFail = "فشل القراءة";
        if (e2 && e2.name === "PasswordException") methodFail = "ملف محمي بكلمة مرور";
        if (e2 && (e2.name === "InvalidPDFException" || /InvalidPDF/i.test(e2.message || ""))) methodFail = "ملف PDF غير صالح/تالف";
        return {
          id: id, name: file.name,
          extractedTotal: null,
          overrideTotal: null,
          method: methodFail,
          debugText: "",
          net: null, vat: null, gross: null
        };
      }
    }

    // إذا كانت فاتورة Scan قد يطلع النص قليل جداً أو صفر
    if (!lines.length){
      log("  ⚠ لم يتم استخراج نص (قد يكون PDF صور/Scan) — استخدم التعديل اليدوي");
    }

    var pick = chooseTotalFromLines(lines);
    var extractedVat = extractVatFromLines(lines);

    var extractedTotal = pick && (pick.value !== undefined) ? pick.value : null;
    var method = pick ? pick.method : "لم يتم العثور على إجمالي";
    if (!usedWorker) method += " (بدون Worker)";

    var debugText = lines.slice(0, 250).join("\n");

    if (extractedTotal !== null){
      log("  ✓ إجمالي مستخرج: " + extractedTotal + " (" + method + ")");
    } else {
      log("  ⚠ لم يتم العثور على الإجمالي — استخدم التعديل اليدوي");
    }

    if (extractedVat !== null){
      log("  ✓ ضريبة مستخرجة: " + extractedVat);
    }

    var includesVat = includesVatEl.checked;

    var breakdown = {net:null, vat:null, gross:null};
    if (extractedTotal !== null) {
      if (includesVat) {
        if (extractedVat !== null && extractedVat < extractedTotal) {
          breakdown = { gross: extractedTotal, vat: extractedVat, net: extractedTotal - extractedVat };
        } else {
          breakdown = computeBreakdown(extractedTotal, true);
        }
      } else {
        if (extractedVat !== null) {
          breakdown = { net: extractedTotal, vat: extractedVat, gross: extractedTotal + extractedVat };
        } else {
          breakdown = computeBreakdown(extractedTotal, false);
        }
      }
    }

    return {
      id: id,
      name: file.name,
      extractedTotal: extractedTotal,
      overrideTotal: null,
      method: method,
      debugText: debugText,
      net: breakdown.net,
      vat: breakdown.vat,
      gross: breakdown.gross
    };
  }

  function escapeHtml(str){
    return String(str || "").replace(/[&<>"']/g, function(s){
      return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" })[s];
    });
  }

  function render(){
    tbody.innerHTML = "";

    if (!invoices.length){
      var tr0 = document.createElement('tr');
      tr0.innerHTML = '<td colspan="8" class="muted">لم يتم رفع ملفات بعد.</td>';
      tbody.appendChild(tr0);
      exportBtn.disabled = true;
      updateSummary();
      return;
    }

    for (var i=0;i<invoices.length;i++){
      var inv = invoices[i];

      var totalUsed = (inv.overrideTotal !== null && isFinite(inv.overrideTotal))
        ? inv.overrideTotal
        : inv.extractedTotal;

      var net = null, vat = null, gross = null;

      if (totalUsed !== null && isFinite(totalUsed)){
        var b = computeBreakdown(totalUsed, includesVatEl.checked);
        if (inv.overrideTotal === null && isFinite(inv.net) && isFinite(inv.vat) && isFinite(inv.gross)) {
          net = inv.net; vat = inv.vat; gross = inv.gross;
        } else {
          net = b.net; vat = b.vat; gross = b.gross;
        }
      }

      inv.net = net; inv.vat = vat; inv.gross = gross;

      var statusPill = (function(){
        if (String(inv.method).indexOf("مطابقة") === 0) return '<span class="pill ok">مطابق</span>';
        if (String(inv.method).indexOf("تخمين") === 0) return '<span class="pill warn">تخمين</span>';
        if (inv.method === "فشل القراءة" || inv.method === "ملف محمي بكلمة مرور" || inv.method === "ملف PDF غير صالح/تالف") return '<span class="pill warn">فشل</span>';
        return '<span class="pill warn">يدوي</span>';
      })();

      var extractedTxt = (inv.extractedTotal === null) ? "—" : formatMoney(inv.extractedTotal);

      var tr = document.createElement('tr');
      tr.innerHTML = ''
        + '<td>'
          + '<div style="font-weight:700">' + escapeHtml(inv.name) + '</div>'
          + '<div class="muted small">' + (inv.extractedTotal === null ? "لم يُستخرج الإجمالي تلقائياً" : "تم استخراج الإجمالي تلقائياً") + '</div>'
        + '</td>'
        + '<td>'
          + statusPill
          + '<div class="muted small" style="margin-top:6px">' + escapeHtml(inv.method) + '</div>'
        + '</td>'
        + '<td class="num mono">' + extractedTxt + '</td>'
        + '<td class="num mono">' + (net === null ? "—" : formatMoney(net)) + '</td>'
        + '<td class="num mono">' + (vat === null ? "—" : formatMoney(vat)) + '</td>'
        + '<td class="num mono">' + (gross === null ? "—" : formatMoney(gross)) + '</td>'
        + '<td>'
          + '<input class="edit mono" inputmode="decimal" placeholder="مثال: 1250.00"'
          + ' value="' + (inv.overrideTotal === null ? "" : inv.overrideTotal) + '" data-id="' + inv.id + '" />'
          + '<div class="muted small" style="margin-top:6px">اتركها فارغة لاعتماد المستخرج</div>'
        + '</td>'
        + '<td>'
          + '<div class="row-actions">'
            + '<button class="btn secondary small" data-action="show" data-id="' + inv.id + '">نص</button>'
            + '<button class="btn danger small" data-action="remove" data-id="' + inv.id + '">حذف</button>'
          + '</div>'
        + '</td>';

      tbody.appendChild(tr);
    }

    exportBtn.disabled = false;
    updateSummary();
  }

  function updateSummary(){
    var sNet = 0, sVat = 0, sGross = 0;

    for (var i=0;i<invoices.length;i++){
      var inv = invoices[i];
      if (isFinite(inv.net)) sNet += inv.net;
      if (isFinite(inv.vat)) sVat += inv.vat;
      if (isFinite(inv.gross)) sGross += inv.gross;
    }

    sumNetEl.textContent = formatMoney(sNet);
    sumVatEl.textContent = formatMoney(sVat);
    sumGrossEl.textContent = formatMoney(sGross);
    countEl.textContent = String(invoices.length);
  }

  tbody.addEventListener('input', function(e){
    var el = e.target;
    if (!el || !el.classList.contains('edit')) return;

    var id = el.getAttribute('data-id');
    var inv = null;
    for (var i=0;i<invoices.length;i++){
      if (invoices[i].id === id) { inv = invoices[i]; break; }
    }
    if (!inv) return;

    var v = String(el.value || "").trim();
    if (!v){
      inv.overrideTotal = null;
    } else {
      var n = parseNumber(v);
      inv.overrideTotal = (n === null) ? null : n;
    }
    render();
  });

  tbody.addEventListener('click', function(e){
    var btn = e.target && e.target.closest ? e.target.closest('button') : null;
    if (!btn) return;

    var action = btn.getAttribute('data-action');
    var id = btn.getAttribute('data-id');

    var inv = null;
    for (var i=0;i<invoices.length;i++){
      if (invoices[i].id === id) { inv = invoices[i]; break; }
    }
    if (!inv) return;

    if (action === 'remove'){
      invoices = invoices.filter(function(x){ return x.id !== id; });
      render();
      return;
    }

    if (action === 'show'){
      var text = inv.debugText || "(لا يوجد نص)";
      alert("مقتطف نص من " + inv.name + ":\n\n" + text.substring(0, 4000) + "\n\n(قد يكون النص أطول)");
      return;
    }
  });

  includesVatEl.addEventListener('change', function(){
    render();
  });

  processBtn.addEventListener('click', async function(){
    var files = [];
    var fl = fileInput.files || [];
    for (var i=0;i<fl.length;i++) files.push(fl[i]);

    if (!files.length){
      alert("اختر ملفات PDF أولاً.");
      return;
    }

    resetLog();
    processBtn.disabled = true;
    processBtn.textContent = "جارٍ المعالجة...";

    try{
      var results = [];
      for (var f=0; f<files.length; f++){
        var inv = await processFile(files[f]);
        results.push(inv);
      }
      invoices = results;
      render();
      log("— انتهت المعالجة.");
    } finally {
      processBtn.disabled = false;
      processBtn.textContent = "معالجة الملفات";
    }
  });

  clearBtn.addEventListener('click', function(){
    invoices = [];
    fileInput.value = "";
    resetLog();
    render();
  });

  exportBtn.addEventListener('click', function(){
    if (!invoices.length) return;

    var rows = [];
    rows.push(["File","Method","ExtractedTotal","OverrideTotal","Net","VAT15","Gross"].join(","));

    for (var i=0;i<invoices.length;i++){
      var inv = invoices[i];
      rows.push([
        csvSafe(inv.name),
        csvSafe(inv.method),
        inv.extractedTotal !== null ? inv.extractedTotal : "",
        inv.overrideTotal !== null ? inv.overrideTotal : "",
        isFinite(inv.net) ? inv.net.toFixed(2) : "",
        isFinite(inv.vat) ? inv.vat.toFixed(2) : "",
        isFinite(inv.gross) ? inv.gross.toFixed(2) : ""
      ].join(","));
    }

    var csv = rows.join("\n");
    var blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    var url = URL.createObjectURL(blob);

    var a = document.createElement('a');
    a.href = url;
    a.download = "invoices_summary.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  function csvSafe(s){
    var t = String(s == null ? "" : s);
    if (/[,"\n]/.test(t)) return '"' + t.replace(/"/g,'""') + '"';
    return t;
  }

  render();
})();
</script>
</body>
</html>
